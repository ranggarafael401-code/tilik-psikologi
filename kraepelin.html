<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Kraepelin | Tilik Psikologi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; user-select: none; }
        .grid-number { font-size: 1.5rem; font-weight: 800; color: #1e293b; opacity: 0.3; transition: all 0.2s; }
        .active-pair { opacity: 1; color: #2563eb; transform: scale(1.2); }
        .bg-tilik { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-tilik text-slate-900 overflow-hidden">

    <div id="instruction-screen" class="min-h-screen flex items-center justify-center p-6">
        <div class="bg-white max-w-md w-full p-10 rounded-3xl shadow-2xl border text-center">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 font-bold text-2xl">1+1</div>
            <h2 class="text-2xl font-bold text-blue-900 mb-4">Cara Mengerjakan</h2>
            <div class="text-slate-600 text-sm space-y-4 mb-8 text-left leading-relaxed">
                <p>1. Akan muncul barisan angka secara vertikal (ke atas).</p>
                <p>2. Jumlahkan angka paling bawah dengan angka di atasnya.</p>
                <p>3. Ketik <strong>Angka Terakhir</strong> saja. <br><span class="text-xs italic text-blue-500">Contoh: 9 + 6 = 15, maka ketik <b>5</b>.</span></p>
                <p>4. Waktu Anda hanya <strong>15 Detik</strong>. Kerjakan secepat mungkin!</p>
            </div>
            <button onclick="startTest()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                Saya Paham, Mulai Tes
            </button>
        </div>
    </div>

    <div id="test-content" class="hidden min-h-screen flex flex-col items-center justify-center relative">
        <div class="absolute top-10 flex flex-col items-center">
            <div id="timer" class="text-4xl font-black text-red-600">15</div>
            <div class="text-[10px] uppercase tracking-widest font-bold text-slate-400">Detik Tersisa</div>
        </div>

        <div class="flex gap-10">
            <div id="number-column" class="flex flex-col-reverse gap-6 items-center">
                </div>
        </div>

        <div class="mt-12">
            <input type="number" id="ans-input" class="w-24 bg-white border-b-4 border-blue-600 text-center text-5xl font-bold py-2 outline-none" placeholder="?" autofocus>
        </div>
    </div>

    <div id="result-screen" class="hidden min-h-screen flex items-center justify-center p-6 text-center">
        <div class="bg-white max-w-md w-full p-8 rounded-3xl shadow-2xl border">
            <h2 class="text-2xl font-bold text-blue-900 mb-6">Hasil Tes Kerja</h2>
            <div class="bg-blue-50 p-6 rounded-2xl mb-8">
                <p class="text-xs text-blue-600 font-bold uppercase mb-2">Penjumlahan Berhasil</p>
                <h3 id="final-skor" class="text-6xl font-black text-blue-900">0</h3>
            </div>
            <button onclick="downloadPDF()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold mb-4">Unduh Hasil PDF</button>
            <a href="index.html" class="block text-sm text-slate-400 hover:text-blue-600 underline">Kembali ke Beranda</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBZsXx_T5-5bKp14BLhuZGNfj4Ils71nVA", authDomain: "tilikpsikologi-cbt.firebaseapp.com", projectId: "tilikpsikologi-cbt", storageBucket: "tilikpsikologi-cbt.firebasestorage.app", messagingSenderId: "940142802410", appId: "1:940142802410:web:5e6579568ed2774d9a2e93" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let numbers = [];
        let currentIndex = 0;
        let score = 0;
        let timeLeft = 15;
        let timer;

        function setupGrid() {
            const col = document.getElementById('number-column');
            col.innerHTML = "";
            numbers = Array.from({length: 50}, () => Math.floor(Math.random() * 9) + 1);
            numbers.forEach((num, i) => {
                const div = document.createElement('div');
                div.className = "grid-number";
                div.id = `num-${i}`;
                div.innerText = num;
                col.appendChild(div);
            });
            updateHighlight();
        }

        function updateHighlight() {
            document.querySelectorAll('.grid-number').forEach(el => el.classList.remove('active-pair'));
            document.getElementById(`num-${currentIndex}`).classList.add('active-pair');
            document.getElementById(`num-${currentIndex + 1}`).classList.add('active-pair');
        }

        window.startTest = () => {
            document.getElementById('instruction-screen').classList.add('hidden');
            document.getElementById('test-content').classList.remove('hidden');
            document.getElementById('ans-input').focus();
            setupGrid();
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if(timeLeft <= 0) finish();
            }, 1000);
        };

        document.getElementById('ans-input').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            const correct = (numbers[currentIndex] + numbers[currentIndex+1]) % 10;
            if(!isNaN(val)) {
                if(val === correct) score++;
                currentIndex++;
                e.target.value = '';
                updateHighlight();
                // Geser kolom agar tetap terlihat
                document.getElementById('number-column').style.transform = `translateY(${currentIndex * 45}px)`;
            }
        });

        async function finish() {
            clearInterval(timer);
            const nama = localStorage.getItem("nama_peserta") || "Peserta";
            const waktu = new Date().toLocaleString("id-ID");
            await addDoc(collection(db, "hasil_tes"), { nama, tes: "Kraepelin", skor: score.toString(), waktu });
            
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-skor').innerText = score;
        }

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("LAPORAN HASIL KRAEPELIN", 105, 20, { align: "center" });
            doc.text(`Nama: ${localStorage.getItem("nama_peserta")}`, 20, 40);
            doc.text(`Skor: ${score} (Benar dalam 15 Detik)`, 20, 50);
            doc.save("Hasil_Kraepelin.pdf");
        };
    </script>
</body>
</html>
