<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Konfigurasi Firebase Rafael
    const firebaseConfig = { 
        apiKey: "AIzaSyBZsXx_T5-5bKp14BLhuZGNfj4Ils71nVA", 
        authDomain: "tilikpsikologi-cbt.firebaseapp.com", 
        projectId: "tilikpsikologi-cbt", 
        storageBucket: "tilikpsikologi-cbt.firebasestorage.app", 
        messagingSenderId: "940142802410", 
        appId: "1:940142802410:web:5e6579568ed2774d9a2e93" 
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let numbers = [];
    let currentIndex = 0;
    let score = 0;
    let timeLeft = 15; // Timer sesuai permintaan
    let timer;

    // Fungsi perbaikan: Memastikan auto-focus dan sinkronisasi data
    document.getElementById('ans-input').addEventListener('input', async (e) => {
        const val = parseInt(e.target.value);
        const correct = (numbers[currentIndex] + numbers[currentIndex+1]) % 10;
        
        if(!isNaN(val)) {
            if(val === correct) score++;
            currentIndex++;
            e.target.value = '';
            
            // Efek visual: Scroll otomatis ke atas (seperti tes koran asli)
            const col = document.getElementById('number-column');
            col.style.transform = `translateY(${currentIndex * 48}px)`;
            updateHighlight();
        }
    });

    async function finish() {
        clearInterval(timer);
        const nama = localStorage.getItem("nama_peserta") || "Anonim";
        const waktu = new Date().toLocaleString("id-ID");

        try {
            // Mengirim ke koleksi hasil_tes
            await addDoc(collection(db, "hasil_tes"), { 
                nama, 
                tes: "Kraepelin", 
                skor: score, 
                waktu: waktu 
            });
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-skor').innerText = score;
        } catch (e) {
            alert("Gagal menyimpan hasil. Pastikan domain sudah di-Authorized di Firebase!");
        }
    }
    // ... sisa fungsi startTest tetap sama
</script>
